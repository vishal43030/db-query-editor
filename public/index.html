<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Query Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // App Component
        function App() {
            const [databases, setDatabases] = React.useState([]);
            const [selectedDatabase, setSelectedDatabase] = React.useState('');
            const [query, setQuery] = React.useState('');
            const [results, setResults] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [exportLoading, setExportLoading] = React.useState(null);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                fetchDatabases();
                
                // Add global F5 listener
                const handleGlobalKeyPress = (e) => {
                    if (e.key === 'F5') {
                        e.preventDefault();
                        if (selectedDatabase && query.trim()) {
                            executeQuery();
                        }
                    }
                };
                
                document.addEventListener('keydown', handleGlobalKeyPress);
                
                return () => {
                    document.removeEventListener('keydown', handleGlobalKeyPress);
                };
            }, [selectedDatabase, query]);

            const fetchDatabases = async () => {
                try {
                    const response = await fetch('/api/databases');
                    const data = await response.json();
                    setDatabases(data.databases || []);
                } catch (err) {
                    setError('Failed to fetch databases');
                    console.error(err);
                }
            };

            const executeQuery = async () => {
                if (!selectedDatabase || !query.trim()) {
                    setError('Please select a database and enter a query');
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    const response = await fetch('/api/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            dbName: selectedDatabase,
                            sql: query.trim()
                        }),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Query failed');
                    }

                    if (data.success) {
                        setResults(data.data || []);
                        
                        // Show notification if limit was automatically added
                        if (data.limitAdded) {
                            setError(`ℹ️ Automatically added LIMIT 100 to prevent large result sets. Original query: "${data.originalSql}"`);
                        } else {
                            setError(null);
                        }
                    } else {
                        setError(data.error || 'Query failed');
                        setResults([]);
                    }
                } catch (err) {
                    setError(err.message);
                    setResults([]);
                } finally {
                    setLoading(false);
                }
            };

            const exportResults = async (format) => {
                if (!selectedDatabase || !query.trim() || results.length === 0) {
                    setError('No results to export');
                    return;
                }

                setExportLoading(format);

                try {
                    const params = new URLSearchParams({
                        dbName: selectedDatabase,
                        sql: query.trim(),
                        format: format
                    });

                    const response = await fetch(`/api/export?${params}`);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Export failed');
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `query_results.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (err) {
                    setError('Export failed: ' + err.message);
                } finally {
                    setExportLoading(null);
                }
            };

            const copyResults = async () => {
                if (results.length === 0) {
                    setError('No results to copy');
                    return;
                }

                try {
                    const headers = Object.keys(results[0]);
                    const csvContent = [
                        headers.join('\t'),
                        ...results.map(row => headers.map(header => row[header] || '').join('\t'))
                    ].join('\n');

                    await navigator.clipboard.writeText(csvContent);
                    alert('Results copied to clipboard!');
                } catch (err) {
                    setError('Failed to copy results');
                }
            };


            return React.createElement('div', { className: 'app' },
                React.createElement('header', { className: 'header' },
                    React.createElement('h1', null, 'SQL Query Editor'),
                    React.createElement('p', null, 'Execute read-only SQL queries against your databases')
                ),
                React.createElement('main', { className: 'main' },
                    React.createElement('div', { className: 'query-section' },
                        React.createElement('div', { className: 'database-selector' },
                            React.createElement('label', { htmlFor: 'database-select', className: 'label' }, 'Select Database:'),
                            React.createElement('select', {
                                id: 'database-select',
                                value: selectedDatabase,
                                onChange: (e) => setSelectedDatabase(e.target.value),
                                className: 'select'
                            }, 
                            React.createElement('option', { value: '' }, '-- Choose a database --'),
                            ...databases.map((db) => 
                                React.createElement('option', { key: db.name, value: db.name }, `${db.name} (${db.type})`)
                            )
                            )
                        ),
                        React.createElement('div', { className: 'query-editor' },
                            React.createElement('label', { htmlFor: 'sql-textarea', className: 'label' }, 'SQL Query (SELECT statements only):'),
                            React.createElement('textarea', {
                                id: 'sql-textarea',
                                value: query,
                                onChange: (e) => setQuery(e.target.value),
                                placeholder: 'Enter your SELECT query here...',
                                className: 'textarea',
                                rows: 8,
                                disabled: loading
                            }),
                            React.createElement('div', { className: 'query-controls' },
                                React.createElement('button', {
                                    onClick: executeQuery,
                                    disabled: loading || !query.trim(),
                                    className: 'btn btn-primary'
                                }, loading ? '⏳ Executing...' : '▶️ Execute Query'),
                                React.createElement('span', { className: 'help-text' }, 'Press F5 to execute')
                            )
                        )
                    ),
                    error && React.createElement('div', { 
                        className: error.startsWith('ℹ️') ? 'info' : 'error' 
                    },
                        React.createElement('strong', null, error.startsWith('ℹ️') ? 'Info:' : 'Error:'), ' ', 
                        error.startsWith('ℹ️') ? error.substring(2).trim() : error
                    ),
                    results.length > 0 && React.createElement('div', { className: 'results-section' },
                        React.createElement('div', { className: 'results-header' },
                            React.createElement('h3', null, `Results (${results.length} rows)`),
                            React.createElement('div', { className: 'export-buttons' },
                                React.createElement('button', { 
                                    onClick: copyResults, 
                                    className: 'btn btn-secondary',
                                    disabled: exportLoading !== null
                                }, '📋 Copy'),
                                React.createElement('button', { 
                                    onClick: () => exportResults('csv'), 
                                    className: 'btn btn-secondary',
                                    disabled: exportLoading !== null
                                }, exportLoading === 'csv' ? '⏳ Exporting CSV...' : '📄 CSV'),
                                React.createElement('button', { 
                                    onClick: () => exportResults('xlsx'), 
                                    className: 'btn btn-secondary',
                                    disabled: exportLoading !== null
                                }, exportLoading === 'xlsx' ? '⏳ Exporting Excel...' : '📊 Excel')
                            )
                        ),
                        results.length === 0 ? 
                            React.createElement('div', { className: 'no-results' },
                                React.createElement('p', null, 'No results to display')
                            ) :
                            React.createElement('div', { className: 'results-table-container' },
                                React.createElement('table', { className: 'results-table' },
                                    React.createElement('thead', null,
                                        React.createElement('tr', null,
                                            ...Object.keys(results[0]).map((column) =>
                                                React.createElement('th', { key: column }, column)
                                            )
                                        )
                                    ),
                                    React.createElement('tbody', null,
                                        ...results.map((row, index) =>
                                            React.createElement('tr', { key: index },
                                                ...Object.keys(results[0]).map((column) =>
                                                    React.createElement('td', { key: column },
                                                        row[column] !== null && row[column] !== undefined 
                                                            ? String(row[column]) 
                                                            : ''
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                    )
                )
            );
        }

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Modern Color Palette */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --primary-light: rgba(102, 126, 234, 0.1);
            --primary-dark: #5a6fd8;
            
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-color: #6366f1;
            --secondary-light: rgba(99, 102, 241, 0.1);
            
            --success-color: #10b981;
            --success-light: rgba(16, 185, 129, 0.1);
            --success-border: rgba(16, 185, 129, 0.2);
            
            --error-color: #ef4444;
            --error-light: rgba(239, 68, 68, 0.1);
            --error-border: rgba(239, 68, 68, 0.2);
            
            --info-color: #06b6d4;
            --info-light: rgba(6, 182, 212, 0.1);
            --info-border: rgba(6, 182, 212, 0.2);
            
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: linear-gradient(135deg, #f0f2f5 0%, #e8ecf1 100%);
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            z-index: 0;
        }

        .header > * {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto;
        }

        .main {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            width: 100%;
        }

        .query-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            transition: box-shadow 0.3s ease;
        }

        .query-section:hover {
            box-shadow: var(--shadow-xl);
        }

        .database-selector {
            margin-bottom: 2rem;
        }

        .label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--gray-700);
            font-size: 0.95rem;
            letter-spacing: 0.025em;
        }

        .select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            background-color: white;
            color: var(--gray-700);
            transition: all 0.2s ease;
            appearance: none;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        .select:hover {
            border-color: var(--gray-300);
        }

        .select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--primary-light);
            transform: translateY(-1px);
        }

        .query-editor {
            margin-bottom: 1.5rem;
        }

        .textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.6;
            resize: vertical;
            min-height: 180px;
            transition: all 0.2s ease;
            background-color: var(--gray-50);
            color: var(--gray-800);
        }

        .textarea:hover {
            border-color: var(--gray-300);
            background-color: white;
        }

        .textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--primary-light);
            background-color: white;
            transform: translateY(-1px);
        }

        .textarea:disabled {
            background-color: var(--gray-100);
            color: var(--gray-500);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .query-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .btn:hover::before {
            transform: translateX(100%);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .help-text {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-text::before {
            content: '⌨️';
            font-size: 1rem;
        }

        .error {
            background: var(--error-light);
            color: var(--error-color);
            padding: 1rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--error-border);
            margin-bottom: 1.5rem;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .error strong {
            font-weight: 700;
        }

        .info {
            background: var(--info-light);
            color: var(--info-color);
            padding: 1rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--info-border);
            margin-bottom: 1.5rem;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .info strong {
            font-weight: 700;
        }

        .results-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            transition: box-shadow 0.3s ease;
        }

        .results-section:hover {
            box-shadow: var(--shadow-xl);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-header h3 {
            color: var(--gray-800);
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .export-buttons .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .results-table-container {
            overflow: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            max-height: 500px;
            max-width: 100%;
            box-shadow: var(--shadow-sm);
            background: white;
        }

        .results-table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .results-table-container::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 6px;
        }

        .results-table-container::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 6px;
            border: 2px solid var(--gray-100);
        }

        .results-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        .results-table-container::-webkit-scrollbar-corner {
            background: var(--gray-100);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
            font-variant-numeric: tabular-nums;
        }

        .results-table th {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 700;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }

        .results-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: top;
            color: var(--gray-700);
            font-weight: 400;
        }

        .results-table tr:nth-child(even) {
            background-color: rgba(248, 250, 252, 0.5);
        }

        .results-table tr:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(99, 102, 241, 0.05) 100%);
            transform: scale(1.001);
            transition: all 0.15s ease;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .no-results::before {
            content: '📊';
            display: block;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .btn:disabled {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main {
                padding: 1rem;
            }
            
            .query-section,
            .results-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .header {
                padding: 1.5rem 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .export-buttons {
                width: 100%;
                justify-content: flex-start;
            }
            
            .query-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.75rem;
            }
            
            .query-section,
            .results-section {
                padding: 1rem;
                border-radius: var(--radius-lg);
            }
            
            .results-table-container {
                max-height: 400px;
            }
            
            .results-table th,
            .results-table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }

        /* Dark mode support (future enhancement) */
        @media (prefers-color-scheme: dark) {
            /* Add dark mode styles here if needed */
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus improvements for better accessibility */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</body>
</html>